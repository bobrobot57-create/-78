# Сохранение базы при redeploy (Railway)

**Проблема:** После каждого redeploy теряются клиенты, коды, настройки.

**Решение:** Добавить **PostgreSQL** и задать переменную `DATABASE_URL` — данные сохранятся.

---

## Способ через Variables (PostgreSQL) — РЕКОМЕНДУЕТСЯ

Volume в Railway может быть скрыт. **PostgreSQL** — надёжная замена, всё настраивается через **Variables**.

### Шаг 1. Добавить PostgreSQL

1. На главном экране проекта нажми **«+ New»** (плюс)
2. Выбери **«Database»** → **«PostgreSQL»**
3. Railway создаст сервис с базой

### Шаг 2. Добавить переменную DATABASE_URL

1. Кликни по **своему сервису с ботом** (не по PostgreSQL)
2. Открой вкладку **«Variables»** (у тебя она уже есть)
3. Нажми **«+ New Variable»**
4. **Name:** `DATABASE_URL`
5. **Value:** скопируй из сервиса PostgreSQL:
   - Кликни по сервису PostgreSQL
   - Variables → найди `DATABASE_URL` → скопируй значение
   - Или используй **«Add Reference»** / «Добавить ссылку», если Railway предлагает

### Шаг 3. Redeploy

Сделай redeploy сервиса с ботом. Код автоматически определит `DATABASE_URL` и переключится на PostgreSQL. Данные не потеряются при следующих redeploy.

### Опционально: нагрузка 200+ клиентов

### Railway Free (0.5 GB RAM, $1/мес)
По умолчанию: `DB_POOL_SIZE=8`, `DB_CONCURRENT_LIMIT=8`, `concurrent_updates=4` (4+4=8 воркеров). При перегрузке webhook возвращает 503 — в логах будет «слоты БД заняты».

### Railway Hobby ($5/мес, больше ресурсов)
Можно увеличить в Variables:
- `DB_POOL_SIZE=20` — размер пула
- `DB_CONCURRENT_LIMIT=16` — макс. одновременных запросов к БД
- `THREAD_POOL_SIZE=16`

### Автоперезапуск при перегрузке

При серии критических ошибок (PoolError, таймаут семафора) процесс завершается — Railway автоматически перезапустит контейнер. Ручной redeploy не нужен.
- `RESTART_ON_ERRORS_COUNT=8` — сколько ошибок подряд (по умолчанию 8)
- `RESTART_ON_ERRORS_WINDOW=120` — за сколько секунд (по умолчанию 120)

---

## Способ через Volume (если доступен)

Volume **не** во вкладке Variables. Его добавляют с главного экрана.

### Где искать Volume

1. Выйди из настроек сервиса на **главный экран** (карточки сервисов)
2. Нажми **Ctrl+K**
3. Введи: `volume`
4. Выбери **«Add Volume»** / **«Attach Volume»**
5. Mount Path: `/data`

---

## Пошаговая инструкция (Volume)

### Шаг 1. Открыть Railway

Зайди на **https://railway.app** и открой свой проект.

---

### Шаг 2. Найти свой сервис

На главном экране проекта видно **карточки сервисов** (блоки с названиями).  
Выбери тот сервис, где запускается бот (обычно там, где `main.py` или `Procfile`).

---

### Шаг 3. Открыть меню добавления Volume

**Вариант А — через Command Palette:**
- Нажми **Ctrl+K** (Windows) или **Cmd+K** (Mac)
- В поиске введи **volume**
- Выбери **«Add Volume»** или **«Attach Volume»** (добавить / прикрепить том)

**Вариант Б — через меню сервиса:**
- Кликни по **карточке своего сервиса** (блок с названием)
- Найди **«⋮»** (три точки) или **«⋯»** в углу карточки
- В меню выбери **«Attach Volume»** / **«Add Volume»** (прикрепить том)

**Вариант В — правый клик:**
- Правый клик по карточке сервиса
- Выбери **«Attach Volume»** / **«Add Volume»**

---

### Шаг 4. Настройка Volume

**4.1. Выбор сервиса**

Если появится выбор сервиса — выбери тот же, в котором запускается бот.

**4.2. Mount Path (путь монтирования)**

После создания Volume появится **новый блок** (Volume) на схеме. Кликни по нему.

В настройках (вкладка **Settings** / **Настройки** или панель справа) найди поле:
- **Mount Path** (англ.)  
- или **«Путь монтирования»** / **«Путь к папке»** (если браузер перевёл)

В это поле введи **ровно** (без кавычек):
```
/data
```

---

### Шаг 5. Создать Volume

Нажми **«Create»** / **«Создать»** / **«Add»** / **«Добавить»**.

---

### Шаг 6. Redeploy

После создания Volume:

1. Открой свой сервис
2. Найди кнопку **«Redeploy»** / **«Переразвернуть»** / **«Deploy»** / **«Развернуть»**
3. Часто она в **«⋮»** (три точки) или в правом верхнем углу
4. Нажми её

---

## Где что искать (кратко)

| Что искать | Где может быть |
|------------|----------------|
| **Add Volume** | Ctrl+K → в списке команд / правый клик по сервису |
| **Mount Path** | В настройках Volume, поле для пути |
| **Redeploy** | В правом верхнем углу сервиса / «⋮» → Redeploy |

---

## Проверка

После redeploy зайди в бота. Если Volume подключён, клиенты и коды не будут теряться при следующих redeploy.

---

## Важно

- Volume создаётся **пустым**. Первый запуск после добавления Volume создаст новую базу.
- Если база уже была до добавления Volume — её нужно один раз восстановить из бэкапа (если есть) или начать заново.
- Дальнейшие redeploy **не будут** сбрасывать данные.
